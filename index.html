<!DOCTYPE html>
<!--
	name: index.html
	author: Bardh and Agon, Lohaj
-->

<head>
	<style type="text/css" >
		#container {
			margin:auto;
			width:800px;
			height:800px;
		}
		
		#fromTxt {
			display: block;
			width:200px;
			float:left;
		}
		#toTxt {
			display: block;
			width:200px;
			float:left;
		}
		
		#placeholder {
			margin-top: 50px;
			width:800px;
			height:50%;
		}
		
		#input_wrapper {
			margin-top: 50px;
			margin-left: 25px;
		}
		
		.filter_wrapper {
			padding:10px;
			background-color: #fafafa;
		}
		
		#tooltip{
			position: absolute;
			display: none;
			border: 1px solid #fdd;
			padding: 2px;
			background-color: #fee;
			opacity: 0.80;
		}
	</style>
	<link href="libs/range/jquery.range.css" rel="stylesheet">
	<meta charset="utf-8">
	<!-- xml2json is a helper to convert the xml format to json -->
	<script language="javascript" type="text/javascript" src="libs/jquery/jquery.js"></script>
	<script language="javascript" type="text/javascript" src="xml2json.js"></script>
	
	<script src="libs/highchart/highcharts.js"></script>
	<script src="libs/highchart/modules/exporting.js"></script>
</head>
<body>

  <h1 id="title"></h1>
  
  <body>
  	<div id="container">
		<h1>HSSP CURVE</h1>
		<div id="description">
			The current implementation works with Blast output version BLASTP 2.2.29+. It is important to note that the values presented here come from a sample output which may contain bad data (test it with your own). The algorithm for calculating HSSP Curve and HSSP Values is referenced from this <a href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC169026/?report=classic">paper</a>.</br>
			</br>Features:
			</br>&nbsp;&nbsp;&nbsp;&nbsp;Ability to filter based on hssp scores
			</br>&nbsp;&nbsp;&nbsp;&nbsp;Ability to zoom by selecting a part of the graph
			</br>&nbsp;&nbsp;&nbsp;&nbsp;Ability to download a screen shot of the graph or print it
			</br>&nbsp;&nbsp;&nbsp;&nbsp;Ability to download all the elements that are below or above the hssp ruve in .txt format (hint: check out the pie chart)
			</br>&nbsp;&nbsp;&nbsp;&nbsp;Ability to show/hide different data from the legend of the graph (hint: click the legend items and see what happens)
			</br>&nbsp;&nbsp;&nbsp;&nbsp;Ability to define the distance from the hssp curve (0 being the original hssp curve)
		</div>
		</br>
		
		<div class="filter_wrapper">
			<h3>Filters</h3>

<!--
			<div class="filter">
			Show >= 100% <input type="checkbox" id="aboveOrEqualTo100">
			</div>
	  		<br/>
-->	  		
	  		<div class="filter">
			Filter based on HSSP score:<br/>
			<input type="text" id="from" value="1"></input> - <input type="text" id="to" value="80.5"></input>
			<button id="filter_graph">Filter</button>		
			</div>
	  		<br/>
	  		<div class="filter">
			HSSP-curve value:
		  	<input type="range" name="hssp_curve_value" id="hssp_curve_distance" step ="1" value="0" min="-19" max="200">
		  	<span>0</span>
			</div>
			<br/>
		</div>

		<div id="placeholder"></div>
		<p style="display:none" id="export">Export:
			</br>
			<a href="javascript:void(0)" download="below.txt" id="below">Download #elements below the hssp curve</a>
			</br>
			<a href="javascript:void(0)" download="above.txt" id="above">Download #elements above the hssp curve</a>
		</p>
		<!--<p id="choices">Show:</p>
		<div id="tooltip"></div>-->
		
		<div id="input_wrapper">
			Put the content of the blast output in XML here:
			<textarea id="xmlArea" rows="1" style="width:100%"></textarea> 
			 <input type="button" value="Clear" onclick="javascript:eraseText();"> 
			<button id="show_graph" id="calculate" >Extract Graph</button>			 
			</br></br>
			<p style="display:none">
			Blast Output automatically parsed into JSON:			
			<textarea id="jsonArea" rows="8"></textarea> 
			</br></br> 
			</p>

			</br></br></br></br></br></br></br></br></br></br>			
		</div>
	</div>
</body>


<script type="text/javascript">

var from = null;
var to = null;
			
var min_hssp_score = -90; // will be found based on the blast input
var max_hssp_score = 80.5; // will be found based on the blast input
var max_sequence_alignment_length = 0;

var hssp_curve_distance = 0;

var original_data = [];
var data = [];
var placeholder = $("#placeholder");

var animator = {
  steps:20,
  duration:5,
  direction: "right"
}

function plotPoints(){
	placeholder.highcharts({
			title: {
                text: 'HSSP Curve'
            },
			xAxis: {
				title: {
					enabled: true,
					text: 'number of aligned residues'
				},
				showLastLabel: true
			},
			yAxis: {
				title: {
					text: '% sequence identity'
				},
				floor :0,
				ceiling :100
			},
			chart: {
				zoomType: 'xy'
			},
			legend: {
				layout: 'vertical',
				align: 'center',
				verticalAlign: 'top',
				y: 70,
				floating: true,
				backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF',
				borderWidth: 1
			},
			series: data
	});
}

function initialise(){
	max_sequence_alignment_length = 0;
	fetchData();
	data = jQuery.extend(true, [], original_data);
	plotHsspCurve();
	refreshDownloadableContent();
	plotPoints();
}

/*
	description:
	This method refreshes the visualisation based on the input fields. It first extracts the data and then plots it to the graph,
	Multiple data are allowed to be ploted over the same graph
*/
function reloadData(){
	// The data is already there, find and refresh based on the new min and max hssp score
	var hssp_curve;
	// Find and store hssp curve
	for(var i = data.length - 1; i >= 0; i--) {
		if(data[i].name === "hssp curve") {
		   hssp_curve = data[i];
		}
	}
	data = jQuery.extend(true, [], original_data);
	data.push(hssp_curve);
	refreshDownloadableContent();
	
	plotPoints();
	//plot = $.plot(placeholder, choices, options);
}
function makeTextFile(text) {
    var data = new Blob([text], {type: 'text/plain'});
    // returns a URL you can use as a href
    return window.URL.createObjectURL(data);
  };

function refreshDownloadableContent(){
	var belowZero = 0;
	var aboveZero = 0;
	var belowZeroData = "";
	var aboveZeroData = "";
	var prev_hit_above_id = "";
	var prev_hit_below_id = "";
	for(var i = data.length - 1; i >= 0; i--) {
		if(data[i].name != "hssp curve"){
			var values = data[i].data;
			aboveZeroData += "Iteration: " + data[i].name + "\r\n";
			belowZeroData += "Iteration: " + data[i].name + "\r\n";
			
			for(var j = values.length - 1; j >= 0; j--) {
				// if we have a min and max hssp score (fetched from all the alignments), check for filters
				var hssp_score = values[j].hssp_score;
				if(hssp_score < from || hssp_score > to){
					values.splice(j, 1);
				}
				else{
					if(hssp_score>= (hssp_curve_distance*100)){
						aboveZero++;
						if(prev_hit_above_id != values[j].id){
							prev_hit_above_id = values[j].id;
							aboveZeroData += "	Hit_ID: " + values[j].id + "\r\n";
						}
						aboveZeroData += "		HSSP_SCORE: " + hssp_score  + "\r\n";
						//aboveZeroData.push(values[j][3]);
					}
					else{
						belowZero++;
						if(prev_hit_below_id != values[j].id){
							prev_hit_below_id = values[j].id;
							belowZeroData += "	Hit_ID: " + values[j].id + "\r\n";
						}
						belowZeroData += "		HSSP_SCORE: " + hssp_score  + "\r\n";
						//belowZeroData.push(values[j][3]);
					}
				}
			}
		}
	}
	var pie = {
            type: 'pie',
			name: "number",
            data: [{
                name: '#elements above HSSP Curve',
				id: 1,
                y: aboveZero,
                color: Highcharts.getOptions().colors[0]
            }, {
                name: '#elements below HSSP Curve',
				id: 2,
                y: belowZero,
                color: Highcharts.getOptions().colors[1] // John's color
            }],
            center: ['10%', '-10%'],
            size: 80,
            showInLegend: false,
			dataLabels :{
				enabled: false
			},
			events:{
				click: function (event){
					if(event.point.id == 1){
						var above = document.getElementById('above');
						above.click();
					}
					else{
						var below = document.getElementById('below');
						below.click();
					}
				}
			},
			tooltip : {
				pointFormat: '{point.y} elements<br><br><i>Click to download</i>'
			}
        };
	data.push(pie);
	var above = document.getElementById('above');
	above.href = makeTextFile(aboveZeroData);
	//above.href = makeTextFile(JSON.stringify(aboveZeroData));
	var below = document.getElementById('below');
	//below.href = makeTextFile(JSON.stringify(belowZeroData));
	below.href = makeTextFile(belowZeroData);
	
	$( "#below" ).html("Download " + belowZero + " elements below the hssp curve");
	$( "#above" ).html("Download " + aboveZero + " elements above the hssp curve");
}

/*
	description:
	This function plots the hsspcurve over the data extracted from the input.
*/
function plotHsspCurve(){
	var values = [];
	
	// TODO: change 0-600 based on the aligned sequences
	for(L = 0; L <= max_sequence_alignment_length; L+=8){
		var pair = [];

		// Calculating PID based on L - number of residues aligned 
		var PID = 0;
		if(L <=11){
			pair.push(L);
			PID = 1 + hssp_curve_distance
			pair.push(PID*100);

		}
		else if(L <= 450){
			var PID = ((480 * Math.pow(L, -0.32*(1 + Math.exp(-L/1000))))/100) + hssp_curve_distance;
				pair.push(L);
				pair.push(PID*100);
		}
		else{
			pair.push(L);
			PID = 0.195 + hssp_curve_distance;
			pair.push(PID*100);
		}
		
		if(!PID < 1.0){
			values.push(pair);		
		}
	}
	var result = {};
	result.name = "hssp curve";
	result.data = values;
	result.lineWidth = 2,
    result.marker = {radius: 3};
	result.pointStart = 0;
	result.tooltip = {
		headerFormat: '<b>Hssp Curve Distance:</b><br>',
		pointFormat: '' + (hssp_curve_distance*100)
	};
	
	data.push(result);
}

// xml to string helper method
function xmlToString(xmlData) { 
    var xmlString;
    //IE
    if (window.ActiveXObject){
        xmlString = xmlData.xml;
    }
    // code for Mozilla, Firefox, Opera, etc.
    else{
        xmlString = (new XMLSerializer()).serializeToString(xmlData);
    }
    return xmlString;
}   

/*
	description:
	Parse the input from the text field and store the data into a data variable which will be used later to plot
*/
function fetchData(){

	original_data = [];
	var json = JSON.stringify(x2js.xml_str2json($("#xmlArea").val()));
	$("#jsonArea").val(json);
	json = jQuery.parseJSON(json);
	var result = json.BlastOutput.BlastOutput_iterations;
	var i = 1;
	if($.isArray(result.Iteration)){
		$.each(result.Iteration, function(key, iteration){
			fetchIteration(iteration, i);
			i++;
		});
	}else{
		fetchIteration(result.Iteration, i);
	}
}

function fetchIteration(iteration, id){
	var label = iteration["Iteration_query-def"];
	var hits = iteration.Iteration_hits.Hit;
	
	var values = [];
	
	if($.isArray(hits)){
		$.each(hits, function(key, iterationHit) {
	    //display the key and value pair
		var hsp = iterationHit.Hit_hsps.Hsp;

		// From the blast output there are cases where only 1 hit was found, in that case an object will be parsed here otherwise the hits are stored into an array
		if($.isArray(hsp)) {
			$.each(hsp, function(key, hspObject) {
				var pair = fetchHsspPair(iterationHit, hspObject);
				if(!jQuery.isEmptyObject(pair)){
					values.push(pair);
				}
			});
		} else {
			var pair = fetchHsspPair(iterationHit, hsp);
			if(!jQuery.isEmptyObject(pair)){
				values.push(pair);
			}		
		}
	});
	}else{
		var hsp = hits.Hit_hsps.Hsp;

		// From the blast output there are cases where only 1 hit was found, in that case an object will be parsed here otherwise the hits are stored into an array
		if($.isArray(hsp)) {
			$.each(hsp, function(key, hspObject) {
				var pair = fetchHsspPair(hits, hspObject);
				if(!jQuery.isEmptyObject(pair)){
					values.push(pair);
				}
			});
		} else {
			var pair = fetchHsspPair(hits, hsp);
			if(!jQuery.isEmptyObject(pair)){
				values.push(pair);
			}
		}
	}
	
	
	
	// save the max and min to "to" and "from"
	if(from == null && to == null){	
		from = $("#from").val(min_hssp_score);	
		to = $("#to").val(max_hssp_score);
	}
	
	var result = {};
	result.name = "Iteration " + id;
	result.data = values;
	result.type = "scatter";
	result.marker = {
		radius: 2,
		states: {
			hover: {
				enabled: true,
				lineColor: 'rgb(100,100,100)'
			}
		}
	};
	result.satates = {
		hover: {
			marker: {
				enabled: false
			}
		}
	};
	result.tooltip = {
		headerFormat: '<b>Item with values:</b><br>',
		pointFormat: '% sequence identity : {point.x}<br>number of aligned residues: {point.y}<br>HSSP score:{point.hssp_score:.2f}',
		valueDecimals: 2
	};
	result.pointStart = 0;
	result.animator = animator;
	original_data.push(result);
}

/*
	input params:
		iterationHit: object
		hspObject: object
	description:
	This method extracts the information needed for ploting that is the pair of number of residues aligned and percentage of sequence similarity extracted from the objects retained from the xml input
	output: 
		pair: of number of residues aligned and percentage of sequence similarity
*/
function fetchHsspPair(iterationHit, hspObject){

	var length = iterationHit.Hit_len;
	var hit_num = iterationHit.Hit_num;
	var id = iterationHit.Hit_id;
	var number_aligned = parseInt(hspObject["Hsp_align-len"]);
	
	var PID = number_aligned*100/length;
	var hssp_score = 0;
	if(number_aligned <= 11){
		hssp_score = PID - 100;
	} else if(number_aligned <= 450){
		hssp_score = PID - (480 * Math.pow(number_aligned, -0.32*(1 + Math.exp(-number_aligned/1000))));
	} else {
		hssp_score = PID - 19.5;
	}	
	
	var percentage = number_aligned/length;

	var pair = {};
	if(percentage >= 1){
		return pair;
	}
	if(number_aligned > max_sequence_alignment_length){
		max_sequence_alignment_length = number_aligned;
	}
	
	// We form number_aligned in the x axis and percentage in y axis
	pair.x = number_aligned;
	pair.y = percentage*100;
	pair.hssp_score = hssp_score;
	pair.id = id;
	return pair;
}

/*
	input params:
		xml: xml_file
	description:
	This method handels the on receive data from the ajax function that will load a sample input on first run and than call the visualisation
*/
function onDataReceived(xml) {

	var xml_string = xmlToString(xml);
	$("#xmlArea").val(xml_string);
	
	initialise();
}

// Call a sample input data located within the repository on first run
$.ajax({
	url: 'data/single.xml',
	method: 'GET',
	dataType: 'xml',
	success: onDataReceived
});

var x2js = new X2JS();
/*
	description:
	Click Handler for the Extract Graph button
*/
$("#show_graph").click(function(){
	initialise();
});


/*
	description:
	Click Handler for the Filter button which filters the graph based on the range of values (from-to)
*/
$("#filter_graph").click(function() {
	from = $("#from").val();
	to = $("#to").val();
	reloadData();
});

/*
	description:
	On mouse move handles which writes the value of the slider on the next html element (a span)
*/
$('#hssp_curve_distance').mousemove(function() {
    $(this).next().html(parseInt($(this).val()));
});

/*
	description:
	On change event handler which writes the value of the slider on the next html element (a span),
	save the new value for the hssp curve distance and refreshes the visualization.
*/
$('#hssp_curve_distance').change(function() {
    $(this).next().html(parseInt($(this).val()));
    
	hssp_curve_distance = $(this).val()/100;
	
	data = jQuery.extend(true, [], original_data);
	plotHsspCurve();
	refreshDownloadableContent();
	plotPoints();
});

function eraseText(){
	$("#xmlArea").val("");	
}

</script>