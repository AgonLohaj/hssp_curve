<!DOCTYPE html>
<head>
	<style>
		#container {
			margin:auto;
			width:600px;
			height:600px;
		}
		
		#placeholder {
			margin-top: 50px;
			width:600px;
			height:50%;
		}
	</style>
	<meta charset="utf-8">
	<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="libs/jquery/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="libs/flot/jquery.flot.js"></script>
	<script language="javascript" type="text/javascript" src="xml2json.js"></script>
</head>
<body>

  <h1 id="title"></h1>
  
  <body>
  	<div id="container">
		<h1>HSSP CURVE</h1>

		<div id="placeholder"></div>
	
		<div id="input_wrapper">
			<textarea id="xmlArea" rows="8" cols="110"></textarea> 
			</br></br>
			<textarea id="jsonArea" rows="8" cols="110"></textarea> 
			</br></br>
			<button id="show_graph" id="calculate" >Extract Graph</button>
		</div>
	</div>
</body>


<script type="text/javascript">

var options = {
	points: { show: true },
	xaxis: { tickDecimals: 0, tickSize: 1000 }
};
var data = [];
var placeholder = $("#placeholder");

function plotData(){
	$.plot(placeholder, data, options);
}

// xml to string helper method
function xmlToString(xmlData) { 
    var xmlString;
    //IE
    if (window.ActiveXObject){
        xmlString = xmlData.xml;
    }
    // code for Mozilla, Firefox, Opera, etc.
    else{
        xmlString = (new XMLSerializer()).serializeToString(xmlData);
    }
    return xmlString;
}   

function fetchData(){

	var json = JSON.stringify(x2js.xml_str2json($("#xmlArea").val()));
	$("#jsonArea").val(json);
	
	var object = jQuery.parseJSON(json);
	var result = object.BlastOutput.BlastOutput_iterations;
	
	var label = result.Iteration["Iteration_query-def"];
	var hits = result.Iteration.Iteration_hits.Hit;
	
	var values = [];
	
	$.each(hits, function(key, value) {
	    //display the key and value pair
		var hsp = value.Hit_hsps.Hsp;

		if( Object.prototype.toString.call( hsp ) === '[object Array]' ) {
			$.each(hsp, function(key, object) {
				var pair = fetchHsspPair(value, object);
				values.push(pair);
			});
		} else {
			var pair = fetchHsspPair(value, hsp);
			values.push(pair);			
		}
	});
	
	var result = {};
	result.label = label;
	result.data = values;
	data.push(result);
}

function fetchHsspPair(value, object){

	var length = value.Hit_len;
	var hit_num = value.Hit_num;

	var number_aligned = object["Hsp_align-len"];
	var percentage = number_aligned/length;
	if(percentage > 1){
		hsp_num = object.Hsp_num;
	}
	
	var pair = [];	
	pair.push(number_aligned);
	pair.push(percentage);
	return pair;
}

function onDataReceived(xml) {

	var xml_string = xmlToString(xml);
	$("#xmlArea").val(xml_string);
	
	fetchData();
	plotData();
}

$.ajax({
	url: 'data/single.xml',
	method: 'GET',
	dataType: 'xml',
	success: onDataReceived
});

var x2js = new X2JS();
$("#show_graph").click(function(){

	fetchData();
	plotData();
});

</script>