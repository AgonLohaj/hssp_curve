<!DOCTYPE html>
<head>
	<style>
		#container {
			margin:auto;
			width:600px;
			height:600px;
		}
		
		#placeholder {
			margin-top: 50px;
			width:600px;
			height:50%;
		}
	</style>
	<meta charset="utf-8">
	<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="libs/jquery/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="libs/flot/jquery.flot.js"></script>
	<script language="javascript" type="text/javascript" src="xml2json.js"></script>
</head>
<body>

  <h1 id="title"></h1>
  
  <body>
  	<div id="container">
		<h1>HSSP CURVE</h1>

		<div id="placeholder"></div>
	
		<div id="input_wrapper">
			<textarea id="xmlArea" rows="8" cols="110"></textarea> 
			</br></br>
			<textarea id="jsonArea" rows="8" cols="110"></textarea> 
			</br></br>
			<button id="show_graph" id="calculate" >Extract Graph</button>
		</div>
	</div>
</body>


<script type="text/javascript">
var options = {
	points: { show: true },
	xaxis: { tickDecimals: 0, tickSize: 1000 }
};
var dummy_data = [];
var placeholder = $("#placeholder");

$.plot(placeholder, dummy_data, options);

var alreadyFetched = {};
// then fetch the data with jQuery

function xmlToString(xmlData) { 
    var xmlString;
    //IE
    if (window.ActiveXObject){
        xmlString = xmlData.xml;
    }
    // code for Mozilla, Firefox, Opera, etc.
    else{
        xmlString = (new XMLSerializer()).serializeToString(xmlData);
    }
    return xmlString;
}   

function onDataReceived(xml) {
	console.log(xml);
	$xml_string = xmlToString(xml);
	$("#xmlArea").val($xml_string);
	$json = JSON.stringify(x2js.xml_str2json($xml_string));
	$("#jsonArea").val($json);
	$object = jQuery.parseJSON($json);
	$result = $object.BlastOutput.BlastOutput_iterations;
	$hits = $result.Iteration.Iteration_hits.Hit;
	$label = $result.Iteration["Iteration_query-def"];
	var data = [];
	var values = [];
	$.each($hits, function(key, value) {
    //display the key and value pair
		var pair = [];
		$length = value.Hit_len;
		$hit_num = value.Hit_num;
		$hsp = value.Hit_hsps.Hsp;
		if( Object.prototype.toString.call( $hsp ) === '[object Array]' ) {
			$.each($hsp, function(key, object) {
				$number_aligned = object["Hsp_align-len"];
				$percentage = $number_aligned/$length;
				if($percentage>1){
					$hsp_num = object.Hsp_num;
					console.log($hit_num + "..." + $hsp_num);
				}
				pair.push($number_aligned);
				pair.push($percentage);
				values.push(pair);
			});
		}
		else{
			$number_aligned = $hsp["Hsp_align-len"];
			$percentage = $number_aligned/$length;
			pair.push($number_aligned);
			pair.push($percentage);
			if($percentage>1){
				$hsp_num = $hsp.Hsp_num;
				console.log($hit_num + "..." + $hsp_num);
			}
			values.push(pair);
		}
	});
	
	$result = {};
	$result.label = $label;
	$result.data = values;
	data.push($result);
	$.plot(placeholder, data, options);
 }

$.ajax({
	url: 'data/single.xml',
	method: 'GET',
	dataType: 'xml',
	success: onDataReceived
});
var x2js = new X2JS();
$("#show_graph").click(function(){
	$json = JSON.stringify(x2js.xml_str2json($("#xmlArea").val()));
	$("#jsonArea").val($json);
	$object = jQuery.parseJSON($json);
	$result = $object.BlastOutput.BlastOutput_iterations;
	$label = $result.Iteration["Iteration_query-def"];
	$hits = $result.Iteration.Iteration_hits.Hit;
	var data = [];
	var values = [];
	$.each($hits, function(key, value) {
    //display the key and value pair
		var pair = [];
		$length = value.Hit_len;
		$hit_num = value.Hit_num;
		$hsp = value.Hit_hsps.Hsp;
		if( Object.prototype.toString.call( $hsp ) === '[object Array]' ) {
			$.each($hsp, function(key, object) {
				$number_aligned = object["Hsp_align-len"];
				$percentage = $number_aligned/$length;
				if($percentage>1){
					$hsp_num = object.Hsp_num;
					console.log($hit_num + "..." + $hsp_num);
				}
				pair.push($number_aligned);
				pair.push($percentage);
				values.push(pair);
			});
		}
		else{
			$number_aligned = $hsp["Hsp_align-len"];
			$percentage = $number_aligned/$length;
			pair.push($number_aligned);
			pair.push($percentage);
			if($percentage>1){
				$hsp_num = $hsp.Hsp_num;
				console.log($hit_num + "..." + $hsp_num);
			}
			values.push(pair);
		}
	});
	
	$result = {};
	$result.label = $label;
	$result.data = values;
	data.push($result);
	$.plot(placeholder, data, options);
	
});
</script>