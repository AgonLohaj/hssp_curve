<!DOCTYPE html>
<!--
	name: index.html
	author: Bardh and Agon, Lohaj
-->

<head>
	<style>
		#container {
			margin:auto;
			width:600px;
			height:600px;
		}
		
		#placeholder {
			margin-top: 50px;
			width:600px;
			height:50%;
		}
		
		#input_wrapper {
			margin-top: 50px;
			margin-left: 25px;
		}
	</style>
	<meta charset="utf-8">
	<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="excanvas.min.js"></script><![endif]-->
	<!-- jQuery will be used by the next libraries so we need to include this -->
    <script language="javascript" type="text/javascript" src="libs/jquery/jquery.js"></script>
	<!-- flot is an open source library for ploting data (source: http://www.flotcharts.org/) -->
    <script language="javascript" type="text/javascript" src="libs/flot/jquery.flot.js"></script>
	
	<!-- helper library to name the axis -->
	<script language="javascript" type="text/javascript" src="libs/flot/jquery.flot.axislabels.js"></script>
	<!-- xml2json is a helper to convert the xml format to json -->
	<script language="javascript" type="text/javascript" src="xml2json.js"></script>
</head>
<body>

  <h1 id="title"></h1>
  
  <body>
  	<div id="container">
		<h1>HSSP CURVE</h1>
		Show >= 100% <input type="checkbox" id="aboveOrEqualTo100">
		<div id="placeholder"></div>
	
		<div id="input_wrapper">
			<textarea id="xmlArea" rows="8" cols="110"></textarea> 
			</br></br>
			<textarea id="jsonArea" rows="8" cols="110"></textarea> 
			</br></br>
			<button id="show_graph" id="calculate" >Extract Graph</button>
		</div>
	</div>
</body>


<script type="text/javascript">

var showAboveOrEqualTo100 = false;

var options = {
	points: { show: true },
	axisLabels: {
            show: true
        },
        xaxes: [{
            axisLabel: 'number of aligned residues',
        }],
        yaxes: [{
            position: 'left',
            axisLabel: '% sequence identity',
        }],
	xaxis: { tickDecimals: 0, tickSize: 1000 }
};

var data = [];
var placeholder = $("#placeholder");

/*
	description:
	This method refreshes the visualisation based on the input fields. It first extracts the data and then plots it to the graph,
	Multiple data are allowed to be ploted over the same graph
*/
function refreshVisualization(){
	fetchData();
	plotData();
}


/*
	description:
	This function will plot the hsspcurve over the data extracted from the input. Its still work on progress
*/
function plotHsspCurve(){
	var values = [];
	for(i = 450; i <= 800; i++){
	
		for(j = 450; j < i; j++){
		
			var rez = j*100/i;
		
			if(rez >= 19 || rez <= 20){
				var percentage = j/i;	
				var pair = [];
				pair.push(j);
				pair.push(percentage);
				values.push(pair);
			}
		}
	}
	var result = {};
	result.label = "hssp curve";
	result.data = values;
	data.push(result);

	$.plot(placeholder, data, options);
}

/*
	description:
	Plot the data using the api of flot library
*/
function plotData(){
	$.plot(placeholder, data, options);
}

// xml to string helper method
function xmlToString(xmlData) { 
    var xmlString;
    //IE
    if (window.ActiveXObject){
        xmlString = xmlData.xml;
    }
    // code for Mozilla, Firefox, Opera, etc.
    else{
        xmlString = (new XMLSerializer()).serializeToString(xmlData);
    }
    return xmlString;
}   

/*
	description:
	Parse the input from the text field and store the data into a data variable which will be used later to plot
*/
function fetchData(){
	var json = JSON.stringify(x2js.xml_str2json($("#xmlArea").val()));
	$("#jsonArea").val(json);
	
	var object = jQuery.parseJSON(json);
	var result = object.BlastOutput.BlastOutput_iterations;
	
	var label = result.Iteration["Iteration_query-def"];
	var hits = result.Iteration.Iteration_hits.Hit;
	
	var values = [];
	
	$.each(hits, function(key, iterationHit) {
	    //display the key and value pair
		var hsp = iterationHit.Hit_hsps.Hsp;

		// From the blast output there are cases where only 1 hit was found, in that case an object will be parsed here otherwise the hits are stored into an array
		if($.isArray(hsp)) {
			$.each(hsp, function(key, hspObject) {
				var pair = fetchHsspPair(iterationHit, hspObject);
				values.push(pair);
			});
		} else {
			var pair = fetchHsspPair(iterationHit, hsp);
			values.push(pair);			
		}
	});
	
	var result = {};
	result.label = label;
	result.data = values;
	data.push(result);
}

/*
	input params:
		iterationHit: object
		hspObject: object
	description:
	This method extracts the information needed for ploting that is the pair of number of residues aligned and percentage of sequence similarity extracted from the objects retained from the xml input
	output: 
		pair: of number of residues aligned and percentage of sequence similarity
*/
function fetchHsspPair(iterationHit, hspObject){

	var length = iterationHit.Hit_len;
	var hit_num = iterationHit.Hit_num;

	var number_aligned = hspObject["Hsp_align-len"];
	
	var PID = number_aligned*100/length;
	
	var hssp = 0;
	
	// *Important* this won't be used to plot the data and the cases for L <= 450 and L<= 11 aren't considered
	// Those cases are mentioned in this paper: http://www.ncbi.nlm.nih.gov/pmc/articles/PMC169026/
	if(length > 450){
		hssp = PID - 19.5;
	}
	
	var percentage = number_aligned/length;

	var pair = [];	
	if(percentage >= 1 && !showAboveOrEqualTo100){	
		return pair;
	}

	// We form number_aligned in the x axis and percentage in y axis
	pair.push(number_aligned);
	pair.push(percentage);
	return pair;
}

/*
	input params:
		xml: xml_file
	description:
	This method handels the on receive data from the ajax function that will load a sample input on first run and than call the visualisation
*/
function onDataReceived(xml) {

	var xml_string = xmlToString(xml);
	$("#xmlArea").val(xml_string);
	
	refreshVisualization();
}

// Call a sample input data located within the repository on first run
$.ajax({
	url: 'data/single.xml',
	method: 'GET',
	dataType: 'xml',
	success: onDataReceived
});

var x2js = new X2JS();
/*
	description:
	Click Handler for the button
*/
$("#show_graph").click(function(){
	refreshVisualization();
});

/*
	description:
	Click Handler for the check button. There are some extreme cases in the sample blast input where the percentages would go above 100,
	as a sort of filter we are setting here the boolean which then will disregard these extreme cases.
*/
$("#aboveOrEqualTo100").change(function() {
	showAboveOrEqualTo100 = $(this).is(":checked");
	
	refreshVisualization();
});

</script>