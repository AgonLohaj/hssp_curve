<!DOCTYPE html>
<head>
	<style>
		#container {
			margin:auto;
			width:600px;
			height:600px;
		}
		
		#placeholder {
			margin-top: 50px;
			width:600px;
			height:50%;
		}
		
		#input_wrapper {
			margin-top: 50px;
			margin-left: 25px;
		}
	</style>
	<meta charset="utf-8">
	<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="libs/jquery/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="libs/flot/jquery.flot.js"></script>
	<script language="javascript" type="text/javascript" src="xml2json.js"></script>
</head>
<body>

  <h1 id="title"></h1>
  
  <body>
  	<div id="container">
		<h1>HSSP CURVE</h1>

		Show >= 100% <input type="checkbox" id="aboveOrEqualTo100">
		<div id="placeholder"></div>
	
		<div id="input_wrapper">
			<textarea id="xmlArea" rows="8" cols="110"></textarea> 
			</br></br>
			<textarea id="jsonArea" rows="8" cols="110"></textarea> 
			</br></br>
			<button id="show_graph" id="calculate" >Extract Graph</button>
		</div>
	</div>
</body>


<script type="text/javascript">

var showAboveOrEqualTo100 = false;

var options = {
	points: { show: true },
	xaxis: { tickDecimals: 0, tickSize: 1000 }
};

var data = [];
var placeholder = $("#placeholder");

function refreshVisualization(){

	fetchData();
	plotData();
}

function plotHsspCurve(){

	var values = [];
	
	for(i = 450; i <= 800; i++){
	
		for(j = 450; j < i; j++){
		
			var rez = j*100/i;
		
			if(rez >= 19 || rez <= 20){
				var percentage = j/i;	
				var pair = [];
				pair.push(j);
				pair.push(percentage);
				values.push(pair);
			}
		}
	}
	
	var result = {};
	result.label = "hssp curve";
	result.data = values;
	data.push(result);

	$.plot(placeholder, data, options);
}

function plotData(){
	$.plot(placeholder, data, options);
}

// xml to string helper method
function xmlToString(xmlData) { 
    var xmlString;
    //IE
    if (window.ActiveXObject){
        xmlString = xmlData.xml;
    }
    // code for Mozilla, Firefox, Opera, etc.
    else{
        xmlString = (new XMLSerializer()).serializeToString(xmlData);
    }
    return xmlString;
}   

function fetchData(){

	data = [];

	var json = JSON.stringify(x2js.xml_str2json($("#xmlArea").val()));
	$("#jsonArea").val(json);
	
	var object = jQuery.parseJSON(json);
	var result = object.BlastOutput.BlastOutput_iterations;
	
	var label = result.Iteration["Iteration_query-def"];
	var hits = result.Iteration.Iteration_hits.Hit;
	
	var values = [];
	
	$.each(hits, function(key, iterationHit) {
	    //display the key and value pair
		var hsp = iterationHit.Hit_hsps.Hsp;

		if($.isArray(hsp)) {
			$.each(hsp, function(key, hspObject) {
				var pair = fetchHsspPair(iterationHit, hspObject);
				values.push(pair);
			});
		} else {
			var pair = fetchHsspPair(iterationHit, hsp);
			values.push(pair);			
		}
	});
	
	var result = {};
	result.label = label;
	result.data = values;
	data.push(result);
}

function fetchHsspPair(iterationHit, hspObject){

	var length = iterationHit.Hit_len;
	var hit_num = iterationHit.Hit_num;

	var number_aligned = hspObject["Hsp_align-len"];
	
	var PID = number_aligned*100/length;
	
	var hssp = 0;
	if(length > 450){
		hssp = PID - 19.5;
	}
	
	var percentage = number_aligned/length;

	var pair = [];	
	if(percentage >= 1 && !showAboveOrEqualTo100){	
		return pair;
	}

	pair.push(number_aligned);
	pair.push(percentage);
	return pair;
}

function onDataReceived(xml) {

	var xml_string = xmlToString(xml);
	$("#xmlArea").val(xml_string);
	
	refreshVisualization();
}

$.ajax({
	url: 'data/single.xml',
	method: 'GET',
	dataType: 'xml',
	success: onDataReceived
});

var x2js = new X2JS();
$("#show_graph").click(function(){

	refreshVisualization();
});

$("#aboveOrEqualTo100").change(function() {
	showAboveOrEqualTo100 = $(this).is(":checked");
	
	refreshVisualization();
});

</script>